# AIæ™ºèƒ½èŠå¤©ç³»ç»Ÿ - éƒ¨ç½²è¿ç»´æ–‡æ¡£

> ç‰ˆæœ¬ï¼šv3.0  
> æ›´æ–°æ—¶é—´ï¼š2025å¹´9æœˆ  
> åŸºäºPostgreSQLæ•°æ®åº“çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

## ğŸ— ç¯å¢ƒè¦æ±‚

### ç¡¬ä»¶è¦æ±‚

#### æœ€å°é…ç½®ï¼ˆå¼€å‘/æµ‹è¯•ç¯å¢ƒï¼‰
- **CPU**: 2æ ¸
- **å†…å­˜**: 4GB
- **å­˜å‚¨**: 20GB SSD
- **ç½‘ç»œ**: 10Mbps

#### æ¨èé…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- **CPU**: 4æ ¸ @ 2.5GHz+
- **å†…å­˜**: 8GB
- **å­˜å‚¨**: 50GB SSD
- **ç½‘ç»œ**: 100Mbps+

### è½¯ä»¶ç¯å¢ƒ

#### å¿…éœ€ç»„ä»¶
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04 LTS / CentOS 8+ / Amazon Linux 2
- **Java**: OpenJDK 17+
- **PostgreSQL**: 14.0+
- **Node.js**: 18.0+ (æ„å»ºæ—¶)
- **Docker**: 20.10+ (å¯é€‰)
- **Nginx**: 1.18+ (åå‘ä»£ç†)

#### å¯é€‰ç»„ä»¶
- **Redis**: 6.0+ (ç¼“å­˜)
- **Prometheus**: ç›‘æ§æŒ‡æ ‡
- **Grafana**: ç›‘æ§é¢æ¿

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### æ–¹æ¡ˆä¸€ï¼šDockeréƒ¨ç½²ï¼ˆæ¨èï¼‰

#### 1. å‡†å¤‡éƒ¨ç½²æ–‡ä»¶

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd springai

# å‡†å¤‡ç¯å¢ƒé…ç½®æ–‡ä»¶
cp .env.example .env
```

#### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
# .envæ–‡ä»¶
# æ•°æ®åº“é…ç½®
POSTGRES_DB=ai_chat
POSTGRES_USER=ai_chat_user
POSTGRES_PASSWORD=your_secure_password
DB_URL=jdbc:postgresql://postgres:5432/ai_chat

# AIæä¾›å•†é…ç½®
OPENAI_API_KEY=sk-your-openai-api-key
KIMI_API_KEY=sk-your-kimi-api-key
DEEPSEEK_API_KEY=sk-your-deepseek-api-key
QWEN_API_KEY=sk-your-qwen-api-key

# æœç´¢é…ç½®
TAVILY_API_KEY=tvly-your-tavily-api-key

# åº”ç”¨é…ç½®
SERVER_PORT=8080
SPRING_PROFILES_ACTIVE=prod
```

#### 3. Docker Composeéƒ¨ç½²

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:14-alpine
    container_name: ai-chat-db
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./src/main/resources/database/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - ai-chat-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: ai-chat-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - ai-chat-network
    restart: unless-stopped
    command: redis-server --appendonly yes

  ai-chat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ai-chat-app
    ports:
      - "8080:8080"
    environment:
      - DB_URL=${DB_URL}
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - KIMI_API_KEY=${KIMI_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - QWEN_API_KEY=${QWEN_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - ai-chat-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  nginx:
    image: nginx:alpine
    container_name: ai-chat-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - ai-chat
    networks:
      - ai-chat-network
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  ai-chat-network:
    driver: bridge
```

#### 4. Dockerfileé…ç½®

```dockerfile
# Multi-stage build for optimal image size
FROM maven:3.9-openjdk-17 AS build

WORKDIR /app

# Copy pom.xml and download dependencies (for layer caching)
COPY pom.xml .
RUN mvn dependency:go-offline -B

# Copy source code and build
COPY src ./src
RUN mvn clean package -DskipTests

# Runtime stage
FROM openjdk:17-jdk-alpine

WORKDIR /app

# Install necessary packages
RUN apk add --no-cache curl postgresql-client

# Create non-root user
RUN addgroup -S appgroup && adduser -S appuser -G appgroup
USER appuser

# Copy application jar
COPY --from=build /app/target/ai-chat-*.jar app.jar

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# JVM optimization
ENV JAVA_OPTS="-Xmx512m -Xms256m -XX:+UseG1GC -XX:+UseContainerSupport"

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

#### 5. å¯åŠ¨éƒ¨ç½²

```bash
# æ„å»ºå’Œå¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f ai-chat

# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:8080/actuator/health
```

### æ–¹æ¡ˆäºŒï¼šä¼ ç»Ÿéƒ¨ç½²

#### 1. PostgreSQLæ•°æ®åº“å®‰è£…

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install postgresql postgresql-contrib

# CentOS/RHEL
sudo dnf install postgresql postgresql-server postgresql-contrib
sudo postgresql-setup --initdb
sudo systemctl enable postgresql
sudo systemctl start postgresql

# åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
sudo -u postgres psql
CREATE DATABASE ai_chat;
CREATE USER ai_chat_user WITH ENCRYPTED PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE ai_chat TO ai_chat_user;
ALTER USER ai_chat_user CREATEDB;
\q

# åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„
psql -U ai_chat_user -d ai_chat -f src/main/resources/database/init.sql
```

#### 2. åº”ç”¨ç¨‹åºéƒ¨ç½²

```bash
# ç¼–è¯‘æ‰“åŒ…
mvn clean package -DskipTests

# åˆ›å»ºåº”ç”¨ç›®å½•
sudo mkdir -p /opt/ai-chat
sudo chown $USER:$USER /opt/ai-chat

# å¤åˆ¶jaråŒ…
cp target/ai-chat-*.jar /opt/ai-chat/app.jar

# åˆ›å»ºé…ç½®æ–‡ä»¶
cat > /opt/ai-chat/application-prod.yml << EOF
server:
  port: 8080

spring:
  profiles:
    active: prod
  datasource:
    url: jdbc:postgresql://localhost:5432/ai_chat
    username: ai_chat_user
    password: your_password
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5

  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      base-url: https://api.openai.com/v1

search:
  enabled: true
  tavily:
    api-key: ${TAVILY_API_KEY}

management:
  endpoints:
    web:
      exposure:
        include: health,metrics,info
  metrics:
    export:
      prometheus:
        enabled: true

logging:
  level:
    root: INFO
    com.example: DEBUG
  file:
    name: /opt/ai-chat/logs/app.log
EOF

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p /opt/ai-chat/logs
```

#### 3. SystemdæœåŠ¡é…ç½®

```bash
# åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶
sudo tee /etc/systemd/system/ai-chat.service << EOF
[Unit]
Description=AI Chat Application
After=network.target postgresql.service

[Service]
Type=simple
User=ai-chat
Group=ai-chat
WorkingDirectory=/opt/ai-chat
ExecStart=/usr/bin/java -jar -Dspring.config.additional-location=/opt/ai-chat/application-prod.yml /opt/ai-chat/app.jar
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=ai-chat

# ç¯å¢ƒå˜é‡
Environment=JAVA_HOME=/usr/lib/jvm/java-17-openjdk
Environment=OPENAI_API_KEY=your-openai-key
Environment=TAVILY_API_KEY=your-tavily-key

# JVMä¼˜åŒ–
Environment=JAVA_OPTS=-Xmx1g -Xms512m -XX:+UseG1GC

[Install]
WantedBy=multi-user.target
EOF

# åˆ›å»ºä¸“ç”¨ç”¨æˆ·
sudo useradd -r -s /bin/false ai-chat
sudo chown -R ai-chat:ai-chat /opt/ai-chat

# å¯åŠ¨æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl enable ai-chat
sudo systemctl start ai-chat

# æ£€æŸ¥çŠ¶æ€
sudo systemctl status ai-chat
```

## ğŸ”§ Nginxåå‘ä»£ç†é…ç½®

### HTTPé…ç½®

```nginx
# /etc/nginx/sites-available/ai-chat
server {
    listen 80;
    server_name your-domain.com;

    # è®¿é—®æ—¥å¿—
    access_log /var/log/nginx/ai-chat-access.log;
    error_log /var/log/nginx/ai-chat-error.log;

    # é™æ€æ–‡ä»¶
    location /static {
        alias /opt/ai-chat/static;
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    # APIä»£ç†
    location /api {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶é…ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # SSEæ”¯æŒ
    location /api/chat/stream {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # SSEç‰¹æ®Šé…ç½®
        proxy_buffering off;
        proxy_cache off;
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        chunked_transfer_encoding off;
        
        # é•¿è¿æ¥æ”¯æŒ
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }

    # å‰ç«¯è·¯ç”±
    location / {
        try_files $uri $uri/ /index.html;
        root /opt/ai-chat/static;
        index index.html;
        
        # ç¼“å­˜é…ç½®
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
```

### HTTPSé…ç½®ï¼ˆLet's Encryptï¼‰

```bash
# å®‰è£…Certbot
sudo apt install certbot python3-certbot-nginx

# è·å–SSLè¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ ä»¥ä¸‹è¡Œ
0 12 * * * /usr/bin/certbot renew --quiet
```

```nginx
# HTTPSé…ç½®
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSLé…ç½®
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # å®‰å…¨å¤´
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection "1; mode=block";

    # å…¶ä»–é…ç½®åŒHTTP
    # ... (å¤åˆ¶ä¸Šè¿°locationé…ç½®)
}

# HTTPé‡å®šå‘åˆ°HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

## ğŸ“Š ç›‘æ§é…ç½®

### åº”ç”¨ç›‘æ§ï¼ˆPrometheus + Grafanaï¼‰

#### 1. Prometheusé…ç½®

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'ai-chat'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 5s

  - job_name: 'postgresql'
    static_configs:
      - targets: ['localhost:9187']

  - job_name: 'nginx'
    static_configs:
      - targets: ['localhost:9113']
```

#### 2. Docker Composeç›‘æ§æ ˆ

```yaml
# åœ¨docker-compose.ymlä¸­æ·»åŠ 
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - ai-chat-network

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/dashboards:/var/lib/grafana/dashboards
    networks:
      - ai-chat-network

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter
    container_name: postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://ai_chat_user:your_password@postgres:5432/ai_chat?sslmode=disable"
    ports:
      - "9187:9187"
    networks:
      - ai-chat-network

volumes:
  prometheus_data:
  grafana_data:
```

### æ—¥å¿—ç®¡ç†ï¼ˆELK Stackï¼‰

```yaml
# docker-compose.elk.yml
version: '3.8'
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.6.0
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data

  kibana:
    image: docker.elastic.co/kibana/kibana:8.6.0
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.6.0
    volumes:
      - ./filebeat.yml:/usr/share/filebeat/filebeat.yml
      - /opt/ai-chat/logs:/var/log/ai-chat
    depends_on:
      - elasticsearch

volumes:
  elasticsearch_data:
```

## ğŸ” å®‰å…¨é…ç½®

### é˜²ç«å¢™è®¾ç½®

```bash
# UFWé˜²ç«å¢™é…ç½®ï¼ˆUbuntuï¼‰
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow from 10.0.0.0/8 to any port 5432  # PostgreSQLï¼ˆå†…ç½‘ï¼‰
sudo ufw allow from 10.0.0.0/8 to any port 8080  # åº”ç”¨ç«¯å£ï¼ˆå†…ç½‘ï¼‰

# æŸ¥çœ‹è§„åˆ™
sudo ufw status
```

### SSL/TLSé…ç½®

```bash
# ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
sudo mkdir -p /etc/nginx/ssl
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout /etc/nginx/ssl/ai-chat.key \
  -out /etc/nginx/ssl/ai-chat.crt

# è®¾ç½®åˆé€‚çš„æƒé™
sudo chmod 600 /etc/nginx/ssl/ai-chat.key
sudo chmod 644 /etc/nginx/ssl/ai-chat.crt
```

### æ•°æ®åº“å®‰å…¨

```sql
-- PostgreSQLå®‰å…¨é…ç½®
-- 1. ä¿®æ”¹é»˜è®¤ç«¯å£ï¼ˆå¯é€‰ï¼‰
ALTER SYSTEM SET port = '5433';

-- 2. é™åˆ¶è¿æ¥
ALTER SYSTEM SET max_connections = '100';
ALTER SYSTEM SET listen_addresses = 'localhost,10.0.0.0/8';

-- 3. å¯ç”¨SSL
ALTER SYSTEM SET ssl = 'on';

-- 4. é…ç½®pg_hba.conf
-- ç¼–è¾‘ /etc/postgresql/14/main/pg_hba.conf
-- host    ai_chat    ai_chat_user    10.0.0.0/8    md5
```

## ğŸ“‹ è¿ç»´è„šæœ¬

### è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# deploy.sh - è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

set -e

PROJECT_DIR="/opt/ai-chat"
BACKUP_DIR="/opt/ai-chat/backups"
SERVICE_NAME="ai-chat"

echo "ğŸš€ å¼€å§‹éƒ¨ç½² AI Chat ç³»ç»Ÿ..."

# 1. å¤‡ä»½æ•°æ®åº“
echo "ğŸ“¦ å¤‡ä»½æ•°æ®åº“..."
mkdir -p $BACKUP_DIR
pg_dump -U ai_chat_user -h localhost ai_chat > $BACKUP_DIR/db_backup_$(date +%Y%m%d_%H%M%S).sql

# 2. åœæ­¢æœåŠ¡
echo "â¹ï¸ åœæ­¢æœåŠ¡..."
sudo systemctl stop $SERVICE_NAME

# 3. å¤‡ä»½å½“å‰ç‰ˆæœ¬
echo "ğŸ’¾ å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
if [ -f "$PROJECT_DIR/app.jar" ]; then
    cp $PROJECT_DIR/app.jar $BACKUP_DIR/app_backup_$(date +%Y%m%d_%H%M%S).jar
fi

# 4. éƒ¨ç½²æ–°ç‰ˆæœ¬
echo "ğŸ“¦ éƒ¨ç½²æ–°ç‰ˆæœ¬..."
cp target/ai-chat-*.jar $PROJECT_DIR/app.jar
chown ai-chat:ai-chat $PROJECT_DIR/app.jar

# 5. å¯åŠ¨æœåŠ¡
echo "â–¶ï¸ å¯åŠ¨æœåŠ¡..."
sudo systemctl start $SERVICE_NAME
sleep 10

# 6. å¥åº·æ£€æŸ¥
echo "ğŸ” å¥åº·æ£€æŸ¥..."
if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
    echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
else
    echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå›æ»šä¸­..."
    sudo systemctl stop $SERVICE_NAME
    cp $BACKUP_DIR/app_backup_$(date +%Y%m%d)*.jar $PROJECT_DIR/app.jar
    sudo systemctl start $SERVICE_NAME
    echo "ğŸ”„ å·²å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬"
    exit 1
fi

echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
```

### ç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# monitor.sh - ç³»ç»Ÿç›‘æ§è„šæœ¬

LOG_FILE="/var/log/ai-chat-monitor.log"
ALERT_EMAIL="admin@yourdomain.com"

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
check_service() {
    if ! systemctl is-active --quiet ai-chat; then
        echo "$(date): AI ChatæœåŠ¡å·²åœæ­¢" >> $LOG_FILE
        echo "AI ChatæœåŠ¡å¼‚å¸¸åœæ­¢ï¼Œè¯·ç«‹å³æ£€æŸ¥ï¼" | mail -s "æœåŠ¡å‘Šè­¦" $ALERT_EMAIL
        # å°è¯•é‡å¯æœåŠ¡
        sudo systemctl restart ai-chat
    fi
}

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
check_database() {
    if ! pg_isready -h localhost -U ai_chat_user > /dev/null 2>&1; then
        echo "$(date): æ•°æ®åº“è¿æ¥å¤±è´¥" >> $LOG_FILE
        echo "PostgreSQLæ•°æ®åº“è¿æ¥å¼‚å¸¸ï¼Œè¯·ç«‹å³æ£€æŸ¥ï¼" | mail -s "æ•°æ®åº“å‘Šè­¦" $ALERT_EMAIL
    fi
}

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk_space() {
    USAGE=$(df /opt/ai-chat | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ $USAGE -gt 80 ]; then
        echo "$(date): ç£ç›˜ç©ºé—´ä¸è¶³ ${USAGE}%" >> $LOG_FILE
        echo "ç£ç›˜ç©ºé—´ä½¿ç”¨ç‡è¾¾åˆ° ${USAGE}%ï¼Œè¯·æ¸…ç†ç©ºé—´ï¼" | mail -s "ç£ç›˜å‘Šè­¦" $ALERT_EMAIL
    fi
}

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
check_memory() {
    MEMORY_USAGE=$(free | grep Mem | awk '{printf("%.0f", ($3/$2) * 100.0)}')
    if [ $MEMORY_USAGE -gt 90 ]; then
        echo "$(date): å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ ${MEMORY_USAGE}%" >> $LOG_FILE
        echo "å†…å­˜ä½¿ç”¨ç‡è¾¾åˆ° ${MEMORY_USAGE}%ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½ï¼" | mail -s "å†…å­˜å‘Šè­¦" $ALERT_EMAIL
    fi
}

# æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
check_service
check_database
check_disk_space
check_memory

echo "$(date): ç›‘æ§æ£€æŸ¥å®Œæˆ" >> $LOG_FILE
```

### æ—¥å¿—è½®è½¬é…ç½®

```bash
# /etc/logrotate.d/ai-chat
/opt/ai-chat/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 ai-chat ai-chat
    postrotate
        systemctl reload ai-chat
    endscript
}
```

## ğŸ”„ å¤‡ä»½ä¸æ¢å¤

### æ•°æ®åº“å¤‡ä»½

```bash
#!/bin/bash
# backup_db.sh - æ•°æ®åº“å¤‡ä»½è„šæœ¬

BACKUP_DIR="/opt/ai-chat/backups/db"
DB_NAME="ai_chat"
DB_USER="ai_chat_user"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# å…¨é‡å¤‡ä»½
pg_dump -U $DB_USER -h localhost $DB_NAME | gzip > $BACKUP_DIR/full_backup_$DATE.sql.gz

# æ¸…ç†7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "æ•°æ®åº“å¤‡ä»½å®Œæˆ: full_backup_$DATE.sql.gz"
```

### æ•°æ®æ¢å¤

```bash
#!/bin/bash
# restore_db.sh - æ•°æ®åº“æ¢å¤è„šæœ¬

if [ $# -ne 1 ]; then
    echo "ç”¨æ³•: $0 <backup_file>"
    exit 1
fi

BACKUP_FILE=$1
DB_NAME="ai_chat"
DB_USER="ai_chat_user"

echo "è­¦å‘Šï¼šæ­¤æ“ä½œå°†è¦†ç›–å½“å‰æ•°æ®åº“ï¼"
read -p "ç¡®è®¤æ¢å¤å—ï¼Ÿ(yes/no): " confirm

if [ "$confirm" = "yes" ]; then
    # åœæ­¢åº”ç”¨æœåŠ¡
    sudo systemctl stop ai-chat
    
    # åˆ é™¤å¹¶é‡å»ºæ•°æ®åº“
    dropdb -U $DB_USER $DB_NAME
    createdb -U $DB_USER $DB_NAME
    
    # æ¢å¤æ•°æ®
    if [[ $BACKUP_FILE == *.gz ]]; then
        gunzip -c $BACKUP_FILE | psql -U $DB_USER -d $DB_NAME
    else
        psql -U $DB_USER -d $DB_NAME < $BACKUP_FILE
    fi
    
    # é‡å¯æœåŠ¡
    sudo systemctl start ai-chat
    
    echo "æ•°æ®æ¢å¤å®Œæˆï¼"
else
    echo "æ¢å¤æ“ä½œå·²å–æ¶ˆ"
fi
```

## âš¡ æ€§èƒ½ä¼˜åŒ–

### JVMä¼˜åŒ–

```bash
# ç”Ÿäº§ç¯å¢ƒJVMå‚æ•°
JAVA_OPTS="-Xms2g -Xmx4g \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -XX:+UseContainerSupport \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/opt/ai-chat/logs/ \
  -Djava.security.egd=file:/dev/./urandom \
  -Dspring.profiles.active=prod"
```

### PostgreSQLä¼˜åŒ–

```sql
-- postgresql.confä¼˜åŒ–é…ç½®
shared_buffers = '256MB'                # 25% of RAM
effective_cache_size = '1GB'            # 75% of RAM
maintenance_work_mem = '64MB'           
checkpoint_completion_target = 0.9
wal_buffers = '16MB'
default_statistics_target = 100
random_page_cost = 1.1                 # SSDä¼˜åŒ–
effective_io_concurrency = 200         # SSDä¼˜åŒ–

# è¿æ¥æ± ä¼˜åŒ–
max_connections = 100
shared_preload_libraries = 'pg_stat_statements'
```

### åº”ç”¨çº§ç¼“å­˜

```yaml
# application-prod.yml
spring:
  cache:
    type: redis
  redis:
    host: localhost
    port: 6379
    timeout: 2000
    jedis:
      pool:
        max-active: 20
        max-idle: 10
        min-idle: 5
```

## â“ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜è§£å†³

#### 1. åº”ç”¨æ— æ³•å¯åŠ¨

```bash
# æ£€æŸ¥æ—¥å¿—
sudo journalctl -u ai-chat -f

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep :8080

# æ£€æŸ¥é…ç½®æ–‡ä»¶
java -jar app.jar --spring.config.location=application-prod.yml --debug
```

#### 2. æ•°æ®åº“è¿æ¥é—®é¢˜

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
psql -h localhost -U ai_chat_user -d ai_chat -c "SELECT version();"

# æ£€æŸ¥PostgreSQLçŠ¶æ€
sudo systemctl status postgresql
sudo tail -f /var/log/postgresql/postgresql-14-main.log
```

#### 3. å†…å­˜æ³„æ¼è¯Šæ–­

```bash
# ç”Ÿæˆheap dump
jcmd <pid> GC.run_finalization
jcmd <pid> VM.gc
jcmd <pid> GC.dump_heap /tmp/heapdump.hprof

# ä½¿ç”¨MATæˆ–VisualVMåˆ†æheap dump
```

#### 4. æ€§èƒ½é—®é¢˜è¯Šæ–­

```bash
# CPUåˆ†æ
top -H -p <java_pid>
jstack <java_pid> > thread_dump.txt

# IOåˆ†æ
iotop
iostat -x 1

# ç½‘ç»œåˆ†æ
netstat -i
ss -tuln
```

### å‘Šè­¦è§„åˆ™

```yaml
# prometheuså‘Šè­¦è§„åˆ™
groups:
  - name: ai-chat-alerts
    rules:
      - alert: ApplicationDown
        expr: up{job="ai-chat"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "AI Chatåº”ç”¨æœåŠ¡ä¸‹çº¿"

      - alert: HighMemoryUsage
        expr: (jvm_memory_used_bytes / jvm_memory_max_bytes) > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "JVMå†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"

      - alert: DatabaseConnectionFailure
        expr: postgresql_up == 0
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQLæ•°æ®åº“è¿æ¥å¤±è´¥"
```

---

**è¿ç»´æ”¯æŒ**: å¦‚é‡éƒ¨ç½²æˆ–è¿ç»´é—®é¢˜ï¼Œè¯·å‚è€ƒæ•…éšœæ’æŸ¥ç« èŠ‚æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ  
**ç›‘æ§å‘Šè­¦**: å»ºè®®é…ç½®å®Œæ•´çš„ç›‘æ§ä½“ç³»ï¼ŒåŠæ—¶å‘ç°å’Œè§£å†³é—®é¢˜  
**å®šæœŸç»´æŠ¤**: å»ºè®®æ¯å‘¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€ï¼Œæ¯æœˆè¿›è¡Œæ€§èƒ½ä¼˜åŒ–è¯„ä¼°