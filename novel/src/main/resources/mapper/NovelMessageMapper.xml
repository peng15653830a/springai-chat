<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.novel.mapper.NovelMessageMapper">

  <resultMap id="messageMap" type="com.example.novel.entity.NovelMessage">
    <id property="id" column="id"/>
    <result property="sessionId" column="session_id"/>
    <result property="role" column="role"/>
    <result property="content" column="content"/>
    <result property="createdAt" column="created_at"/>
  </resultMap>

  <insert id="insert" parameterType="com.example.novel.entity.NovelMessage" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO novel_messages (session_id, role, content, created_at)
    VALUES (#{sessionId}, #{role}, #{content}, NOW())
  </insert>

  <select id="selectBySessionId" resultMap="messageMap">
    SELECT * FROM novel_messages WHERE session_id = #{sessionId} ORDER BY created_at ASC
  </select>

  <select id="selectBySessionIdWithLimit" resultMap="messageMap">
    SELECT * FROM novel_messages WHERE session_id = #{sessionId} ORDER BY created_at DESC LIMIT #{limit}
  </select>

  <!-- 新增：支持ChatMemory -->
  <select id="findBySessionId" resultMap="messageMap">
    SELECT * FROM novel_messages WHERE session_id = #{sessionId} ORDER BY created_at ASC
  </select>

  <delete id="deleteBySessionId">
    DELETE FROM novel_messages WHERE session_id = #{sessionId}
  </delete>

</mapper>
