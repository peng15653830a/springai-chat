# 开发指南

## 🛠 开发环境要求

### 基础环境
- **JDK**: 1.8+
- **Maven**: 3.6+
- **Node.js**: 16+
- **npm**: 8+
- **MySQL**: 8.0+ (生产环境) / H2 (开发环境)

### 推荐IDE
- **后端**: IntelliJ IDEA / Eclipse
- **前端**: VS Code / WebStorm

## 🚀 快速开始

### 1. 克隆项目
```bash
git clone <repository-url>
cd springai
```

### 2. 配置环境变量
参考 [API配置指南](../deployment/API配置指南.md) 设置必要的环境变量：

```bash
# AI API 配置
export AI_API_KEY="sk-your-kimi-api-key"
export AI_API_URL="https://api.moonshot.cn/v1/chat/completions"

# 搜索 API 配置
export METASO_API_KEY="your-metaso-api-key"

# 数据库配置（如使用MySQL）
export DB_URL="jdbc:mysql://localhost:3306/ai_chat?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai"
export DB_USERNAME="ai_chat_user"
export DB_PASSWORD="your_password"
```

### 3. 后端启动
```bash
# 使用Maven启动
mvn spring-boot:run

# 或打包后启动
mvn clean package
java -jar target/ai-chat-0.0.1-SNAPSHOT.jar
```

### 4. 前端启动
```bash
cd frontend
npm install
npm run dev
```

### 5. 访问应用
- 前端应用: http://localhost:3000
- 后端API: http://localhost:8080
- H2控制台: http://localhost:8080/h2-console (开发环境)
- 健康检查: http://localhost:8080/actuator/health

## 📁 项目结构

### 后端结构
```
src/main/java/com/example/
├── controller/           # 控制器层 - 处理HTTP请求
│   ├── ChatController.java      # AI对话相关接口
│   ├── ConversationController.java  # 对话管理接口  
│   └── UserController.java      # 用户管理接口
├── service/              # 服务层 - 业务逻辑
│   ├── impl/
│   │   ├── AiChatServiceImpl.java   # AI对话核心服务
│   │   ├── ConversationServiceImpl.java # 对话管理服务
│   │   ├── MessageServiceImpl.java  # 消息管理服务
│   │   ├── SearchServiceImpl.java   # 搜索服务
│   │   └── UserServiceImpl.java     # 用户管理服务
│   └── SseEmitterManager.java   # SSE连接管理
├── mapper/               # 数据访问层 - MyBatis映射器
├── entity/               # 实体类 - 数据模型
├── dto/                 # 数据传输对象
├── config/              # 配置类
│   ├── AiConfig.java        # AI模型配置
│   ├── HttpClientConfig.java # HTTP客户端配置
│   ├── JacksonConfig.java   # JSON序列化配置
│   └── MyBatisConfig.java   # MyBatis配置
└── exception/           # 异常处理
```

### 前端结构
```
frontend/src/
├── components/          # 可复用组件
├── views/              # 页面组件  
├── stores/             # Pinia状态管理
├── router/             # 路由配置
├── api/                # API接口封装
├── utils/              # 工具函数
└── assets/             # 静态资源
```

## 📝 开发规范

### 后端开发规范

#### 编码规范
- 使用Lombok减少样板代码
- 统一使用`@RestController`和`@RequestMapping`
- 异常处理使用`ApiResponse<T>`统一返回格式
- 数据库操作使用事务注解`@Transactional`
- 日志使用SLF4J和Logback

#### API设计规范
```java
@RestController
@RequestMapping("/api/example")
@CrossOrigin(origins = "*")
@Slf4j
public class ExampleController {
    
    @Autowired
    private ExampleService exampleService;
    
    @PostMapping
    public ApiResponse<Entity> create(@RequestBody @Valid CreateRequest request) {
        try {
            Entity entity = exampleService.create(request);
            log.info("创建成功，ID: {}", entity.getId());
            return ApiResponse.success("创建成功", entity);
        } catch (BusinessException e) {
            log.error("业务异常: {}", e.getMessage());
            return ApiResponse.error(e.getMessage());
        } catch (Exception e) {
            log.error("系统异常", e);
            return ApiResponse.error("创建失败: " + e.getMessage());
        }
    }
}
```

#### 数据库规范
- 表名使用复数形式，字段使用下划线命名
- 主键统一使用`BIGINT AUTO_INCREMENT`
- 时间字段统一使用`TIMESTAMP`，默认值`CURRENT_TIMESTAMP`
- 外键约束使用`ON DELETE CASCADE`
- 重要字段添加索引

### 前端开发规范

#### Vue 3 组件规范
- 使用Composition API
- 组件名使用PascalCase
- 文件名使用PascalCase
- 使用Element Plus组件库
- 状态管理使用Pinia

#### API调用规范
```javascript
// api/chat.js
import { api } from './index'

export const chatApi = {
  // 发送消息
  sendMessage: (conversationId, data) => 
    api.post(`/chat/conversations/${conversationId}/messages`, data),
  
  // 获取对话列表
  getConversations: (userId) => 
    api.get('/conversations', { params: { userId } }),
    
  // SSE连接
  streamChat: (conversationId) => 
    `/api/chat/stream/${conversationId}`
}
```

#### 组件开发规范
```vue
<template>
  <div class="component-name">
    <!-- 组件内容 -->
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useStore } from '@/stores'

// Props定义
const props = defineProps({
  id: {
    type: Number,
    required: true
  }
})

// Emits定义  
const emits = defineEmits(['update', 'delete'])

// 响应式数据
const loading = ref(false)
const data = ref(null)

// 计算属性
const computedValue = computed(() => {
  return data.value ? data.value.processed : ''
})

// 生命周期
onMounted(() => {
  fetchData()
})

// 方法
const fetchData = async () => {
  loading.value = true
  try {
    // API调用
  } finally {
    loading.value = false
  }
}
</script>

<style scoped>
.component-name {
  /* 组件样式 */
}
</style>
```

## 🔧 开发工具配置

### IntelliJ IDEA配置
1. **安装必要插件**:
   - Lombok Plugin
   - MyBatisX
   - Vue.js

2. **启用注解处理**: 
   `Preferences > Build > Compiler > Annotation Processors`

3. **代码格式配置**: 
   `Preferences > Editor > Code Style > Java`

4. **数据库工具**: 
   配置DataSource连接MySQL/H2数据库

### VS Code配置
推荐插件:
- **Vue Language Features (Volar)** - Vue 3支持
- **TypeScript Vue Plugin (Volar)** - TS支持
- **ESLint** - 代码检查
- **Prettier** - 代码格式化
- **Auto Rename Tag** - 标签重命名
- **Bracket Pair Colorizer** - 括号高亮
- **GitLens** - Git增强

## 🐛 调试指南

### 后端调试
1. **IDE断点调试**:
   - 在关键方法设置断点
   - 使用Debug模式启动Spring Boot
   - 通过Variables窗口查看变量值

2. **日志调试**:
   ```yaml
   # application-dev.yml
   logging:
     level:
       com.example: DEBUG
       org.springframework.web: DEBUG
       com.example.service.impl: TRACE
   ```

3. **数据库调试**:
   - H2控制台查看数据变化
   - MyBatis SQL日志输出
   - 使用DBeaver等工具查看数据库

### 前端调试
1. **浏览器开发者工具**:
   - Console查看错误日志
   - Network检查API调用
   - Application查看本地存储

2. **Vue DevTools**:
   - 组件树查看
   - Pinia状态查看
   - 事件时间轴

3. **SSE连接调试**:
   ```javascript
   // 开启SSE调试日志
   const eventSource = new EventSource(url)
   eventSource.onopen = () => console.log('SSE连接打开')
   eventSource.onerror = (error) => console.error('SSE错误:', error)
   eventSource.onmessage = (event) => console.log('收到消息:', event.data)
   ```

## 🧪 测试指南

### 后端测试
```bash
# 运行所有测试
mvn test

# 运行指定测试类
mvn test -Dtest=ChatControllerTest

# 运行集成测试
mvn integration-test

# 生成测试覆盖率报告
mvn jacoco:report
```

#### 测试示例
```java
@SpringBootTest
@Transactional
@TestPropertySource(properties = {
    "ai.chat.api-key=test-key",
    "search.metaso.api-key=test-key"
})
class ChatControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @Test
    void shouldSendMessage() throws Exception {
        mockMvc.perform(post("/api/chat/conversations/1/messages")
                .contentType(MediaType.APPLICATION_JSON)
                .content("{\"content\":\"测试消息\",\"searchEnabled\":true}"))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.success").value(true));
    }
}
```

### 前端测试
```bash
cd frontend

# 单元测试
npm run test

# E2E测试  
npm run test:e2e

# 覆盖率报告
npm run test:coverage
```

### API测试
使用Postman或curl测试API:

```bash
# 用户登录
curl -X POST http://localhost:8080/api/users/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","nickname":"测试用户"}'

# 创建对话
curl -X POST "http://localhost:8080/api/conversations?userId=1" \
  -H "Content-Type: application/json" \
  -d '{"title":"测试对话"}'

# 发送消息
curl -X POST http://localhost:8080/api/chat/conversations/1/messages \
  -H "Content-Type: application/json" \
  -d '{"content":"你好","searchEnabled":true}'

# SSE连接测试
curl -N http://localhost:8080/api/chat/stream/1
```

## 📦 构建和部署

### 本地构建
```bash
# 构建后端
mvn clean package -DskipTests

# 构建前端
cd frontend
npm run build

# 复制前端构建产物到后端静态资源目录
cp -r dist/* ../src/main/resources/static/
```

### Docker部署
```dockerfile
# Dockerfile
FROM openjdk:8-jdk-alpine
VOLUME /tmp
COPY target/ai-chat-0.0.1-SNAPSHOT.jar app.jar
ENTRYPOINT ["java","-jar","/app.jar"]
```

```bash
# 构建镜像
docker build -t ai-chat .

# 运行容器
docker run -p 8080:8080 \
  -e AI_API_KEY=your-key \
  -e METASO_API_KEY=your-key \
  ai-chat
```

## 🔍 性能优化

### 后端性能优化
1. **数据库优化**:
   - 合适的索引策略
   - 连接池配置优化
   - 查询语句优化

2. **缓存策略**:
   - Redis缓存热点数据
   - Spring Cache注解
   - 静态资源缓存

3. **异步处理**:
   - AI响应异步处理
   - 搜索结果异步获取
   - @Async注解使用

### 前端性能优化
1. **构建优化**:
   - 代码分割和懒加载
   - Tree shaking
   - 压缩和混淆

2. **运行时优化**:
   - 虚拟滚动
   - 防抖节流
   - 图片懒加载

## 🛡 安全考虑

### 后端安全
- **API密钥安全**: 使用环境变量，绝不提交到代码库
- **输入验证**: @Valid注解和自定义验证器
- **SQL注入防护**: MyBatis预编译语句
- **CORS配置**: 生产环境限制域名

### 前端安全  
- **XSS防护**: Vue自动转义，谨慎使用v-html
- **敏感信息**: 不在前端存储敏感数据
- **HTTPS**: 生产环境强制HTTPS

## 🤝 开发工作流

### Git工作流
1. **分支策略**:
   - `master`: 主分支，生产环境代码
   - `develop`: 开发分支
   - `feature/*`: 功能分支
   - `hotfix/*`: 热修复分支

2. **提交规范**:
   ```
   feat: 新功能
   fix: 修复bug  
   docs: 文档更新
   style: 代码格式调整
   refactor: 代码重构
   test: 测试相关
   chore: 构建或辅助工具变动
   ```

### 开发流程
1. 从`develop`分支创建功能分支
2. 在功能分支上开发和测试
3. 提交Pull Request到`develop`分支
4. 代码审查通过后合并
5. 定期从`develop`合并到`master`部署

## 📚 技术参考

### 官方文档
- [Spring Boot文档](https://spring.io/projects/spring-boot)
- [Spring AI文档](https://docs.spring.io/spring-ai/reference/)
- [MyBatis文档](https://mybatis.org/mybatis-3/)
- [Vue 3文档](https://vuejs.org/)
- [Element Plus文档](https://element-plus.org/)

### 第三方服务文档
- [月之暗面Kimi API](https://platform.moonshot.cn/docs/)
- [秘塔搜索API](https://metaso.cn/api-docs)

## ❓ 常见问题

### 环境配置问题
**Q: 后端启动失败，提示端口被占用**  
A: 使用`lsof -i :8080`查看端口占用，或修改`application.yml`中的端口

**Q: AI API调用失败**  
A: 检查API密钥配置，确认网络连接，查看日志中的具体错误信息

**Q: MySQL连接失败**  
A: 检查数据库服务状态，验证连接参数，确认防火墙设置

### 开发问题
**Q: SSE连接频繁断开**  
A: 检查网络稳定性，调整超时配置，实现重连机制

**Q: 前端代理请求失败**  
A: 确认后端服务已启动，检查`vite.config.js`中的代理配置

**Q: Markdown渲染异常**  
A: 参考[SSE技术方案文档](../design/SSE实时渲染技术方案.md)的解决方案

---

## 任务开发计划参考

### 项目开发里程碑

#### ✅ 已完成阶段 
1. **项目架构搭建** - Spring Boot + Vue3 + MyBatis技术栈
2. **数据库设计** - 用户、对话、消息表结构
3. **核心API开发** - 用户登录、对话管理、消息发送
4. **AI集成** - Spring AI + 月之暗面Kimi API
5. **搜索集成** - 秘塔搜索API集成
6. **SSE实时通信** - 流式响应和连接管理
7. **前端界面** - 聊天界面、消息渲染、SSE连接

#### 🚀 持续优化方向
1. **性能优化** - 数据库索引、缓存策略、前端优化
2. **用户体验** - 消息动画、错误处理、离线支持
3. **功能扩展** - 文件上传、消息搜索、主题切换
4. **安全加固** - 身份验证、权限控制、数据加密

### 预期交付成果
- ✅ 完整的Spring Boot后端API服务
- ✅ Vue3前端聊天界面
- ✅ AI对话和联网搜索功能
- ✅ SSE流式响应支持
- ✅ MySQL数据库支持
- ✅ 完整的技术文档

如有开发问题，请参考相关技术文档或提出Issue讨论。