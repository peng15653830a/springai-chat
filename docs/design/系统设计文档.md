# AI智能聊天应用 - 系统设计文档

## 1. 系统架构设计

### 1.1 整体架构
```
┌─────────────────┐    HTTP + SSE        ┌─────────────────┐
│   Vue3前端      │ ←─────────────────→ │  Spring Boot    │
│   - Element UI  │                      │  后端服务       │
│   - Axios       │                      │                 │
│   - EventSource │                      │                 │
└─────────────────┘                      └─────────────────┘
                                                  │
                                                  ├─→ Spring AI / Kimi API
                                                  ├─→ 秘塔搜索API
                                                  └─→ MySQL + MyBatis
```

### 1.2 技术栈选择

#### 后端技术栈
- **JDK**: 1.8
- **Spring Boot**: 2.7.18
- **Spring AI**: 0.8.1
- **数据库**: MySQL 8.0
- **ORM**: MyBatis 3.5.x
- **Web**: Spring Web, Server-Sent Events
- **工具库**: Lombok, Jackson, Apache HttpClient

#### 前端技术栈（第二代架构）
- **框架**: Vue 3.3.8 + Vite 4.5.0
- **UI组件**: Element Plus 2.4.2
- **HTTP客户端**: Axios 1.5.0
- **实时通信**: @vueuse/core useEventSource 13.6.0 (专业SSE组件)
- **状态管理**: Pinia 2.1.7
- **Markdown渲染**: vue-markdown-render 2.2.1 (Vue 3原生支持)
- **代码高亮**: highlight.js 11.11.1
- **工具库**: @vueuse/core, lodash-es

#### 技术架构演进
- **第一代**（2025-08-08之前）：自制SSE逻辑 + @kangc/v-md-editor
- **第二代**（2025-08-15）：专业组件化 - 使用@vueuse/core + vue-markdown-render
- **代码量优化**：从300+行自制逻辑简化为21行标准实现
- **稳定性提升**：替换兼容性问题组件，使用久经考验的专业方案

## 2. 数据库设计

### 2.1 表结构设计

#### 用户表 (users)
```sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    nickname VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 对话会话表 (conversations)
```sql
CREATE TABLE conversations (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    title VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id)
);
```

#### 消息表 (messages)
```sql
CREATE TABLE messages (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    conversation_id BIGINT NOT NULL,
    role VARCHAR(20) NOT NULL COMMENT 'user or assistant',
    content TEXT NOT NULL,
    thinking TEXT COMMENT 'AI推理过程',
    search_results TEXT COMMENT 'JSON格式的搜索结果',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_conversation_id (conversation_id)
);
```

### 2.2 实体类设计

#### User实体
```java
@Data
public class User {
    private Long id;
    private String username;
    private String nickname;
    private Date createdAt;
    private Date updatedAt;
}
```

#### Conversation实体
```java
@Data
public class Conversation {
    private Long id;
    private Long userId;
    private String title;
    private Date createdAt;
    private Date updatedAt;
}
```

#### Message实体
```java
@Data
public class Message {
    private Long id;
    private Long conversationId;
    private String role;
    private String content;
    private String thinking;
    private String searchResults;
    private Date createdAt;
}
```

## 3. API设计

### 3.1 RESTful API接口

#### 用户管理
- `POST /api/users/login` - 用户登录

#### 对话管理
- `GET /api/conversations?userId={id}` - 获取对话列表
- `POST /api/conversations?userId={id}` - 创建新对话
- `GET /api/conversations/{id}` - 获取对话详情
- `DELETE /api/conversations/{id}` - 删除对话
- `GET /api/conversations/{id}/messages` - 获取对话消息

#### 消息管理
- `POST /api/chat/conversations/{id}/messages` - 发送消息
- `GET /api/chat/stream/{conversationId}` - SSE流式接收AI回复

### 3.2 SSE消息格式

#### 发送消息请求
```json
{
  "content": "用户输入的消息",
  "searchEnabled": true
}
```

#### SSE事件格式
```
event: start
data: {"messageId": null}

event: chunk  
data: {"content": "AI回复的部分内容"}

event: search
data: {"type": "start", "message": "正在搜索相关信息..."}

event: end
data: {"messageId": 123}
```

## 4. 核心功能实现

### 4.1 智能标题生成
- 在AI回复完成后自动检查对话标题
- 如果标题为空或为"新对话"，则根据第一条用户消息生成标题
- 生成规则：
  - 消息长度 ≤ 15字符：直接使用
  - 查找第一个完整句子（≤ 20字符）
  - 否则截取前15字符并添加省略号

### 4.2 实时流式响应
- 使用SSE技术实现AI回复的实时流式显示
- 支持打字机效果的逐字显示
- 自动重连机制保证连接稳定性

### 4.3 联网搜索集成
- 集成秘塔搜索API，支持中文优化搜索
- 用户可通过开关控制是否启用搜索
- 搜索结果自动整合到AI回复中

### 4.4 Markdown渲染（第二代）
- **组件选择**: vue-markdown-render (Vue 3原生支持)
- **渲染能力**: 支持表格、代码块、数学公式等完整Markdown语法
- **实时流式**: 完美支持SSE流式内容的实时渲染更新
- **性能优化**: 轻量级组件，渲染效率高
- **兼容性**: 解决Vue 3兼容性问题，替代@kangc/v-md-editor

## 5. 核心服务设计

### 5.1 AI聊天服务 (AiChatService)
```java
@Service
public class AiChatServiceImpl implements AiChatService {
    
    @Autowired
    private SseEmitterManager sseEmitterManager;
    
    @Autowired
    private SearchService searchService;
    
    @Async
    public CompletableFuture<AiResponse> processMessageAsync(Long conversationId, String userMessage, boolean searchEnabled) {
        // 1. 保存用户消息
        // 2. 执行搜索（如果启用）
        // 3. 调用AI服务获取流式响应
        // 4. 通过SSE推送响应块
        // 5. 生成对话标题（如果需要）
        // 6. 保存AI回复
    }
}
```

### 5.2 SSE连接管理器
```java
@Component
public class SseEmitterManager {
    private final Map<Long, SseEmitter> emitters = new ConcurrentHashMap<>();
    
    public SseEmitter createEmitter(Long conversationId) {
        SseEmitter emitter = new SseEmitter(300000L); // 5分钟超时
        emitters.put(conversationId, emitter);
        
        emitter.onCompletion(() -> emitters.remove(conversationId));
        emitter.onTimeout(() -> emitters.remove(conversationId));
        emitter.onError(ex -> emitters.remove(conversationId));
        
        return emitter;
    }
    
    public void sendMessage(Long conversationId, String eventName, Object data) {
        // 发送SSE事件到指定会话
    }
}
```

### 5.3 搜索服务
```java
@Service
public class SearchServiceImpl implements SearchService {
    
    public List<SearchResult> searchWithMetaso(String query) {
        // 调用秘塔搜索API
        // 解析搜索结果
        // 返回结构化数据
    }
}
```

## 6. 配置文件

### 6.1 application.yml
```yaml
server:
  port: 8080

spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/ai_chat?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true&useSSL=false&createDatabaseIfNotExist=true
    username: root
    password: ${DB_PASSWORD:password}
    
  h2:
    console:
      enabled: true
      path: /h2-console
      
mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.example.entity
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl

# AI配置
ai:
  chat:
    api-key: ${AI_API_KEY}
    api-url: ${AI_API_URL:https://api.moonshot.cn/v1/chat/completions}
    model: kimi-k2-0711-preview

# 搜索配置  
search:
  metaso:
    api-key: ${METASO_API_KEY}
    api-url: https://metaso-api.com/search
    
# 异步配置
spring:
  task:
    execution:
      pool:
        core-size: 5
        max-size: 20
```

## 7. 前端组件设计

### 7.1 主要页面组件（第二代架构）
- `Chat.vue` - 聊天主界面，使用@vueuse/core管理SSE连接
- `ConversationList` - 对话历史列表
- `MessageList` - 消息展示区域，使用vue-markdown-render渲染
- `MessageInput` - 消息输入组件
- `VueMarkdownRender` - 标准化Markdown渲染组件
- `SearchIndicator` - 搜索结果指示器
- `RightPanel` - 搜索结果面板

### 7.2 状态管理 (Pinia)
```javascript
// stores/chat.js - 第二代实现
export const useChatStore = defineStore('chat', {
  state: () => ({
    conversations: [],
    currentConversation: null,
    messages: [],
    isLoading: false,
    isConnected: false  // SSE连接状态，由useEventSource管理
  }),
  
  actions: {
    async loadConversations(userId) {
      // 加载用户对话列表
    },
    
    async sendMessage(conversationId, content, searchEnabled) {
      // 发送消息，SSE响应由useEventSource自动处理
    },
    
    // 移除自制SSE方法，使用@vueuse/core的useEventSource
    setConnected(status) {
      this.isConnected = status
    }
  }
})
```

### 7.3 SSE连接管理（第二代）
```javascript
// Chat.vue - 使用专业组件
import { useEventSource } from '@vueuse/core'

// 专业组件替代自制逻辑
const { data, status, error, close, open } = useEventSource(
  sseUrl,
  [],
  {
    immediate: false,
    autoReconnect: {
      retries: 3,
      delay: 1000,
      onFailed() {
        ElMessage.error('连接失败，请检查网络')
      }
    }
  }
)

// 监听数据变化，21行核心逻辑替代150+行自制实现
watch(sseData, (newData) => {
  if (newData) {
    const sseEvent = JSON.parse(newData)
    handleSSEEvent(sseEvent)
  }
})
```

## 8. 性能优化

### 8.1 数据库优化
- 对frequently queried字段添加索引
- 使用连接池优化数据库连接
- 分页查询避免大量数据加载

### 8.2 前端优化（第二代） 
- **组件轻量化**: 使用vue-markdown-render替代重型编辑器
- **代码简化**: 21行SSE逻辑替代300+行自制实现
- **消息列表虚拟滚动**: 处理大量历史消息
- **图片懒加载**: 优化页面加载性能
- **组件按需加载**: Vite自动代码分割

### 8.3 SSE连接优化（第二代）
- **专业组件**: @vueuse/core useEventSource久经考验的实现
- **自动重连**: 内置智能重连机制（3次重试，1秒延迟）
- **连接生命周期**: 自动处理连接建立、维持、清理
- **错误恢复**: 专业级错误处理和状态管理
- **内存优化**: 组件销毁时自动清理资源

## 9. 安全考虑

### 9.1 API安全
- API密钥环境变量存储
- 输入参数验证和过滤
- 防止XSS和SQL注入

### 9.2 数据安全
- 敏感数据加密存储
- HTTPS传输加密
- 用户输入内容过滤

## 10. 架构演进总结（2025-08-15更新）

### 重大技术架构改进

#### 第二代架构核心变更
1. **SSE连接管理专业化**
   - 移除150+行自制EventSource逻辑
   - 采用@vueuse/core useEventSource专业组件
   - 实现自动重连、错误恢复、状态管理

2. **Markdown渲染组件升级**
   - 弃用@kangc/v-md-editor（Vue 3兼容性问题）
   - 采用vue-markdown-render（Vue 3原生支持）
   - 解决实时渲染格式问题

#### 量化改进成果
- **代码量减少**: 从300+行减少到21行核心逻辑
- **稳定性提升**: 使用久经考验的专业组件
- **维护成本降低**: 标准化技术栈，易于维护
- **Vue 3兼容性**: 完全解决兼容性问题

#### 技术决策原则
1. **专业组件优于自制**: 复杂功能交给专业组件处理
2. **标准化胜过定制化**: 选择业界通用方案
3. **简洁性重于完整性**: 21行代码胜过300行复杂实现
4. **长期维护性**: 关注技术债务和维护成本

### 相关文档
- [SSE实时渲染技术方案.md](./SSE实时渲染技术方案.md) - SSE技术详细方案
- [Markdown渲染技术方案.md](./Markdown渲染技术方案.md) - Markdown渲染技术详解

---

这个设计文档涵盖了系统的各个方面，为开发提供了完整的技术参考。第二代架构通过专业组件化显著提升了系统的稳定性和可维护性。