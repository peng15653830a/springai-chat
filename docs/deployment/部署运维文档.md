# AI智能聊天系统 - 部署运维文档

> 版本：v3.0  
> 更新时间：2025年9月  
> 基于PostgreSQL数据库的生产环境部署指南

## 🏗 环境要求

### 硬件要求

#### 最小配置（开发/测试环境）
- **CPU**: 2核
- **内存**: 4GB
- **存储**: 20GB SSD
- **网络**: 10Mbps

#### 推荐配置（生产环境）
- **CPU**: 4核 @ 2.5GHz+
- **内存**: 8GB
- **存储**: 50GB SSD
- **网络**: 100Mbps+

### 软件环境

#### 必需组件
- **操作系统**: Ubuntu 20.04 LTS / CentOS 8+ / Amazon Linux 2
- **Java**: OpenJDK 17+
- **PostgreSQL**: 14.0+
- **Node.js**: 18.0+ (构建时)
- **Docker**: 20.10+ (可选)
- **Nginx**: 1.18+ (反向代理)

#### 可选组件
- **Redis**: 6.0+ (缓存)
- **Prometheus**: 监控指标
- **Grafana**: 监控面板

## 🚀 快速部署

### 方案一：Docker部署（推荐）

#### 1. 准备部署文件

```bash
# 克隆项目
git clone <repository-url>
cd springai

# 准备环境配置文件
cp .env.example .env
```

#### 2. 配置环境变量

```bash
# .env文件
# 数据库配置
POSTGRES_DB=ai_chat
POSTGRES_USER=ai_chat_user
POSTGRES_PASSWORD=your_secure_password
DB_URL=jdbc:postgresql://postgres:5432/ai_chat

# AI提供商配置
OPENAI_API_KEY=sk-your-openai-api-key
KIMI_API_KEY=sk-your-kimi-api-key
DEEPSEEK_API_KEY=sk-your-deepseek-api-key
QWEN_API_KEY=sk-your-qwen-api-key

# 搜索配置
TAVILY_API_KEY=tvly-your-tavily-api-key

# 应用配置
SERVER_PORT=8080
SPRING_PROFILES_ACTIVE=prod
```

#### 3. Docker Compose部署

```yaml
# docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:14-alpine
    container_name: ai-chat-db
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./src/main/resources/database/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - ai-chat-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: ai-chat-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - ai-chat-network
    restart: unless-stopped
    command: redis-server --appendonly yes

  ai-chat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ai-chat-app
    ports:
      - "8080:8080"
    environment:
      - DB_URL=${DB_URL}
      - DB_USERNAME=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - KIMI_API_KEY=${KIMI_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - QWEN_API_KEY=${QWEN_API_KEY}
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - ai-chat-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  nginx:
    image: nginx:alpine
    container_name: ai-chat-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - ai-chat
    networks:
      - ai-chat-network
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  ai-chat-network:
    driver: bridge
```

#### 4. Dockerfile配置

```dockerfile
# Multi-stage build for optimal image size
FROM maven:3.9-openjdk-17 AS build

WORKDIR /app

# Copy pom.xml and download dependencies (for layer caching)
COPY pom.xml .
RUN mvn dependency:go-offline -B

# Copy source code and build
COPY src ./src
RUN mvn clean package -DskipTests

# Runtime stage
FROM openjdk:17-jdk-alpine

WORKDIR /app

# Install necessary packages
RUN apk add --no-cache curl postgresql-client

# Create non-root user
RUN addgroup -S appgroup && adduser -S appuser -G appgroup
USER appuser

# Copy application jar
COPY --from=build /app/target/ai-chat-*.jar app.jar

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# JVM optimization
ENV JAVA_OPTS="-Xmx512m -Xms256m -XX:+UseG1GC -XX:+UseContainerSupport"

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

#### 5. 启动部署

```bash
# 构建和启动服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f ai-chat

# 检查健康状态
curl http://localhost:8080/actuator/health
```

### 方案二：传统部署

#### 1. PostgreSQL数据库安装

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install postgresql postgresql-contrib

# CentOS/RHEL
sudo dnf install postgresql postgresql-server postgresql-contrib
sudo postgresql-setup --initdb
sudo systemctl enable postgresql
sudo systemctl start postgresql

# 创建数据库和用户
sudo -u postgres psql
CREATE DATABASE ai_chat;
CREATE USER ai_chat_user WITH ENCRYPTED PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE ai_chat TO ai_chat_user;
ALTER USER ai_chat_user CREATEDB;
\q

# 初始化数据库表结构
psql -U ai_chat_user -d ai_chat -f src/main/resources/database/init.sql
```

#### 2. 应用程序部署

```bash
# 编译打包
mvn clean package -DskipTests

# 创建应用目录
sudo mkdir -p /opt/ai-chat
sudo chown $USER:$USER /opt/ai-chat

# 复制jar包
cp target/ai-chat-*.jar /opt/ai-chat/app.jar

# 创建配置文件
cat > /opt/ai-chat/application-prod.yml << EOF
server:
  port: 8080

spring:
  profiles:
    active: prod
  datasource:
    url: jdbc:postgresql://localhost:5432/ai_chat
    username: ai_chat_user
    password: your_password
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5

  ai:
    openai:
      api-key: ${OPENAI_API_KEY}
      base-url: https://api.openai.com/v1

search:
  enabled: true
  tavily:
    api-key: ${TAVILY_API_KEY}

management:
  endpoints:
    web:
      exposure:
        include: health,metrics,info
  metrics:
    export:
      prometheus:
        enabled: true

logging:
  level:
    root: INFO
    com.example: DEBUG
  file:
    name: /opt/ai-chat/logs/app.log
EOF

# 创建日志目录
mkdir -p /opt/ai-chat/logs
```

#### 3. Systemd服务配置

```bash
# 创建systemd服务文件
sudo tee /etc/systemd/system/ai-chat.service << EOF
[Unit]
Description=AI Chat Application
After=network.target postgresql.service

[Service]
Type=simple
User=ai-chat
Group=ai-chat
WorkingDirectory=/opt/ai-chat
ExecStart=/usr/bin/java -jar -Dspring.config.additional-location=/opt/ai-chat/application-prod.yml /opt/ai-chat/app.jar
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=ai-chat

# 环境变量
Environment=JAVA_HOME=/usr/lib/jvm/java-17-openjdk
Environment=OPENAI_API_KEY=your-openai-key
Environment=TAVILY_API_KEY=your-tavily-key

# JVM优化
Environment=JAVA_OPTS=-Xmx1g -Xms512m -XX:+UseG1GC

[Install]
WantedBy=multi-user.target
EOF

# 创建专用用户
sudo useradd -r -s /bin/false ai-chat
sudo chown -R ai-chat:ai-chat /opt/ai-chat

# 启动服务
sudo systemctl daemon-reload
sudo systemctl enable ai-chat
sudo systemctl start ai-chat

# 检查状态
sudo systemctl status ai-chat
```

## 🔧 Nginx反向代理配置

### HTTP配置

```nginx
# /etc/nginx/sites-available/ai-chat
server {
    listen 80;
    server_name your-domain.com;

    # 访问日志
    access_log /var/log/nginx/ai-chat-access.log;
    error_log /var/log/nginx/ai-chat-error.log;

    # 静态文件
    location /static {
        alias /opt/ai-chat/static;
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    # API代理
    location /api {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # SSE支持
    location /api/chat/stream {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # SSE特殊配置
        proxy_buffering off;
        proxy_cache off;
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        chunked_transfer_encoding off;
        
        # 长连接支持
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }

    # 前端路由
    location / {
        try_files $uri $uri/ /index.html;
        root /opt/ai-chat/static;
        index index.html;
        
        # 缓存配置
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
```

### HTTPS配置（Let's Encrypt）

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加以下行
0 12 * * * /usr/bin/certbot renew --quiet
```

```nginx
# HTTPS配置
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL配置
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # 安全头
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection "1; mode=block";

    # 其他配置同HTTP
    # ... (复制上述location配置)
}

# HTTP重定向到HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

## 📊 监控配置

### 应用监控（Prometheus + Grafana）

#### 1. Prometheus配置

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'ai-chat'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 5s

  - job_name: 'postgresql'
    static_configs:
      - targets: ['localhost:9187']

  - job_name: 'nginx'
    static_configs:
      - targets: ['localhost:9113']
```

#### 2. Docker Compose监控栈

```yaml
# 在docker-compose.yml中添加
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - ai-chat-network

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/dashboards:/var/lib/grafana/dashboards
    networks:
      - ai-chat-network

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter
    container_name: postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://ai_chat_user:your_password@postgres:5432/ai_chat?sslmode=disable"
    ports:
      - "9187:9187"
    networks:
      - ai-chat-network

volumes:
  prometheus_data:
  grafana_data:
```

### 日志管理（ELK Stack）

```yaml
# docker-compose.elk.yml
version: '3.8'
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.6.0
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data

  kibana:
    image: docker.elastic.co/kibana/kibana:8.6.0
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.6.0
    volumes:
      - ./filebeat.yml:/usr/share/filebeat/filebeat.yml
      - /opt/ai-chat/logs:/var/log/ai-chat
    depends_on:
      - elasticsearch

volumes:
  elasticsearch_data:
```

## 🔐 安全配置

### 防火墙设置

```bash
# UFW防火墙配置（Ubuntu）
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow from 10.0.0.0/8 to any port 5432  # PostgreSQL（内网）
sudo ufw allow from 10.0.0.0/8 to any port 8080  # 应用端口（内网）

# 查看规则
sudo ufw status
```

### SSL/TLS配置

```bash
# 生成自签名证书（测试环境）
sudo mkdir -p /etc/nginx/ssl
sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout /etc/nginx/ssl/ai-chat.key \
  -out /etc/nginx/ssl/ai-chat.crt

# 设置合适的权限
sudo chmod 600 /etc/nginx/ssl/ai-chat.key
sudo chmod 644 /etc/nginx/ssl/ai-chat.crt
```

### 数据库安全

```sql
-- PostgreSQL安全配置
-- 1. 修改默认端口（可选）
ALTER SYSTEM SET port = '5433';

-- 2. 限制连接
ALTER SYSTEM SET max_connections = '100';
ALTER SYSTEM SET listen_addresses = 'localhost,10.0.0.0/8';

-- 3. 启用SSL
ALTER SYSTEM SET ssl = 'on';

-- 4. 配置pg_hba.conf
-- 编辑 /etc/postgresql/14/main/pg_hba.conf
-- host    ai_chat    ai_chat_user    10.0.0.0/8    md5
```

## 📋 运维脚本

### 自动化部署脚本

```bash
#!/bin/bash
# deploy.sh - 自动化部署脚本

set -e

PROJECT_DIR="/opt/ai-chat"
BACKUP_DIR="/opt/ai-chat/backups"
SERVICE_NAME="ai-chat"

echo "🚀 开始部署 AI Chat 系统..."

# 1. 备份数据库
echo "📦 备份数据库..."
mkdir -p $BACKUP_DIR
pg_dump -U ai_chat_user -h localhost ai_chat > $BACKUP_DIR/db_backup_$(date +%Y%m%d_%H%M%S).sql

# 2. 停止服务
echo "⏹️ 停止服务..."
sudo systemctl stop $SERVICE_NAME

# 3. 备份当前版本
echo "💾 备份当前版本..."
if [ -f "$PROJECT_DIR/app.jar" ]; then
    cp $PROJECT_DIR/app.jar $BACKUP_DIR/app_backup_$(date +%Y%m%d_%H%M%S).jar
fi

# 4. 部署新版本
echo "📦 部署新版本..."
cp target/ai-chat-*.jar $PROJECT_DIR/app.jar
chown ai-chat:ai-chat $PROJECT_DIR/app.jar

# 5. 启动服务
echo "▶️ 启动服务..."
sudo systemctl start $SERVICE_NAME
sleep 10

# 6. 健康检查
echo "🔍 健康检查..."
if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
    echo "✅ 部署成功！"
else
    echo "❌ 健康检查失败，回滚中..."
    sudo systemctl stop $SERVICE_NAME
    cp $BACKUP_DIR/app_backup_$(date +%Y%m%d)*.jar $PROJECT_DIR/app.jar
    sudo systemctl start $SERVICE_NAME
    echo "🔄 已回滚到上一版本"
    exit 1
fi

echo "🎉 部署完成！"
```

### 监控脚本

```bash
#!/bin/bash
# monitor.sh - 系统监控脚本

LOG_FILE="/var/log/ai-chat-monitor.log"
ALERT_EMAIL="admin@yourdomain.com"

# 检查服务状态
check_service() {
    if ! systemctl is-active --quiet ai-chat; then
        echo "$(date): AI Chat服务已停止" >> $LOG_FILE
        echo "AI Chat服务异常停止，请立即检查！" | mail -s "服务告警" $ALERT_EMAIL
        # 尝试重启服务
        sudo systemctl restart ai-chat
    fi
}

# 检查数据库连接
check_database() {
    if ! pg_isready -h localhost -U ai_chat_user > /dev/null 2>&1; then
        echo "$(date): 数据库连接失败" >> $LOG_FILE
        echo "PostgreSQL数据库连接异常，请立即检查！" | mail -s "数据库告警" $ALERT_EMAIL
    fi
}

# 检查磁盘空间
check_disk_space() {
    USAGE=$(df /opt/ai-chat | tail -1 | awk '{print $5}' | sed 's/%//')
    if [ $USAGE -gt 80 ]; then
        echo "$(date): 磁盘空间不足 ${USAGE}%" >> $LOG_FILE
        echo "磁盘空间使用率达到 ${USAGE}%，请清理空间！" | mail -s "磁盘告警" $ALERT_EMAIL
    fi
}

# 检查内存使用
check_memory() {
    MEMORY_USAGE=$(free | grep Mem | awk '{printf("%.0f", ($3/$2) * 100.0)}')
    if [ $MEMORY_USAGE -gt 90 ]; then
        echo "$(date): 内存使用率过高 ${MEMORY_USAGE}%" >> $LOG_FILE
        echo "内存使用率达到 ${MEMORY_USAGE}%，请检查系统负载！" | mail -s "内存告警" $ALERT_EMAIL
    fi
}

# 执行所有检查
check_service
check_database
check_disk_space
check_memory

echo "$(date): 监控检查完成" >> $LOG_FILE
```

### 日志轮转配置

```bash
# /etc/logrotate.d/ai-chat
/opt/ai-chat/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 ai-chat ai-chat
    postrotate
        systemctl reload ai-chat
    endscript
}
```

## 🔄 备份与恢复

### 数据库备份

```bash
#!/bin/bash
# backup_db.sh - 数据库备份脚本

BACKUP_DIR="/opt/ai-chat/backups/db"
DB_NAME="ai_chat"
DB_USER="ai_chat_user"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 全量备份
pg_dump -U $DB_USER -h localhost $DB_NAME | gzip > $BACKUP_DIR/full_backup_$DATE.sql.gz

# 清理7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

echo "数据库备份完成: full_backup_$DATE.sql.gz"
```

### 数据恢复

```bash
#!/bin/bash
# restore_db.sh - 数据库恢复脚本

if [ $# -ne 1 ]; then
    echo "用法: $0 <backup_file>"
    exit 1
fi

BACKUP_FILE=$1
DB_NAME="ai_chat"
DB_USER="ai_chat_user"

echo "警告：此操作将覆盖当前数据库！"
read -p "确认恢复吗？(yes/no): " confirm

if [ "$confirm" = "yes" ]; then
    # 停止应用服务
    sudo systemctl stop ai-chat
    
    # 删除并重建数据库
    dropdb -U $DB_USER $DB_NAME
    createdb -U $DB_USER $DB_NAME
    
    # 恢复数据
    if [[ $BACKUP_FILE == *.gz ]]; then
        gunzip -c $BACKUP_FILE | psql -U $DB_USER -d $DB_NAME
    else
        psql -U $DB_USER -d $DB_NAME < $BACKUP_FILE
    fi
    
    # 重启服务
    sudo systemctl start ai-chat
    
    echo "数据恢复完成！"
else
    echo "恢复操作已取消"
fi
```

## ⚡ 性能优化

### JVM优化

```bash
# 生产环境JVM参数
JAVA_OPTS="-Xms2g -Xmx4g \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -XX:+UseContainerSupport \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/opt/ai-chat/logs/ \
  -Djava.security.egd=file:/dev/./urandom \
  -Dspring.profiles.active=prod"
```

### PostgreSQL优化

```sql
-- postgresql.conf优化配置
shared_buffers = '256MB'                # 25% of RAM
effective_cache_size = '1GB'            # 75% of RAM
maintenance_work_mem = '64MB'           
checkpoint_completion_target = 0.9
wal_buffers = '16MB'
default_statistics_target = 100
random_page_cost = 1.1                 # SSD优化
effective_io_concurrency = 200         # SSD优化

# 连接池优化
max_connections = 100
shared_preload_libraries = 'pg_stat_statements'
```

### 应用级缓存

```yaml
# application-prod.yml
spring:
  cache:
    type: redis
  redis:
    host: localhost
    port: 6379
    timeout: 2000
    jedis:
      pool:
        max-active: 20
        max-idle: 10
        min-idle: 5
```

## ❓ 故障排查

### 常见问题解决

#### 1. 应用无法启动

```bash
# 检查日志
sudo journalctl -u ai-chat -f

# 检查端口占用
sudo netstat -tlnp | grep :8080

# 检查配置文件
java -jar app.jar --spring.config.location=application-prod.yml --debug
```

#### 2. 数据库连接问题

```bash
# 测试数据库连接
psql -h localhost -U ai_chat_user -d ai_chat -c "SELECT version();"

# 检查PostgreSQL状态
sudo systemctl status postgresql
sudo tail -f /var/log/postgresql/postgresql-14-main.log
```

#### 3. 内存泄漏诊断

```bash
# 生成heap dump
jcmd <pid> GC.run_finalization
jcmd <pid> VM.gc
jcmd <pid> GC.dump_heap /tmp/heapdump.hprof

# 使用MAT或VisualVM分析heap dump
```

#### 4. 性能问题诊断

```bash
# CPU分析
top -H -p <java_pid>
jstack <java_pid> > thread_dump.txt

# IO分析
iotop
iostat -x 1

# 网络分析
netstat -i
ss -tuln
```

### 告警规则

```yaml
# prometheus告警规则
groups:
  - name: ai-chat-alerts
    rules:
      - alert: ApplicationDown
        expr: up{job="ai-chat"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "AI Chat应用服务下线"

      - alert: HighMemoryUsage
        expr: (jvm_memory_used_bytes / jvm_memory_max_bytes) > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "JVM内存使用率过高"

      - alert: DatabaseConnectionFailure
        expr: postgresql_up == 0
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL数据库连接失败"
```

---

**运维支持**: 如遇部署或运维问题，请参考故障排查章节或联系技术支持  
**监控告警**: 建议配置完整的监控体系，及时发现和解决问题  
**定期维护**: 建议每周检查系统状态，每月进行性能优化评估