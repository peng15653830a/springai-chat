# 数据库配置指南

## MySQL 数据库配置

应用已配置为使用 MySQL 数据库。请按以下步骤设置数据库：

### 1. 安装 MySQL

#### macOS
```bash
brew install mysql
brew services start mysql
```

#### Ubuntu/Debian
```bash
sudo apt update
sudo apt install mysql-server
sudo systemctl start mysql
sudo systemctl enable mysql
```

#### Windows
从 [MySQL 官网](https://dev.mysql.com/downloads/mysql/) 下载并安装 MySQL

### 2. 创建数据库

连接到 MySQL 并创建数据库：

```sql
-- 连接到 MySQL
mysql -u root -p

-- 创建数据库
CREATE DATABASE ai_chat 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

-- 创建用户（可选，建议生产环境使用）
CREATE USER 'ai_chat_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON ai_chat.* TO 'ai_chat_user'@'localhost';
FLUSH PRIVILEGES;
```

### 3. 配置应用连接

在 `application.yml` 或环境变量中配置数据库连接：

```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/ai_chat?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true&useSSL=false&createDatabaseIfNotExist=true
    username: ai_chat_user  # 或使用 root
    password: your_password
```

或使用环境变量：

```bash
export DB_URL="jdbc:mysql://localhost:3306/ai_chat?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true&useSSL=false&createDatabaseIfNotExist=true"
export DB_USERNAME="ai_chat_user"
export DB_PASSWORD="your_password"
```

### 4. 数据库表初始化

应用启动时会自动执行 `src/main/resources/data.sql` 中的初始化脚本，包括：

- 创建必要的数据表（users, conversations, messages）
- 插入初始测试数据

## H2 数据库配置（开发环境）

如果你想使用 H2 内存数据库进行开发：

```yaml
spring:
  datasource:
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:testdb
    username: sa
    password: password
  
  h2:
    console:
      enabled: true
      path: /h2-console
```

访问 H2 控制台：http://localhost:8080/h2-console

## 数据库迁移记录

### ✅ 已完成的迁移

1. **从 H2 迁移到 MySQL**（2025-08-08）
   - 成功将所有表结构迁移到 MySQL
   - 数据类型适配（H2 → MySQL）
   - 字符集配置为 utf8mb4

2. **表结构优化**
   - 添加适当的索引
   - 优化字段长度和类型
   - 添加外键约束

### 表结构说明

#### users 表
```sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    nickname VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### conversations 表
```sql
CREATE TABLE conversations (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    title VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

#### messages 表
```sql
CREATE TABLE messages (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    conversation_id BIGINT NOT NULL,
    role VARCHAR(20) NOT NULL COMMENT 'user or assistant',
    content TEXT NOT NULL,
    thinking TEXT COMMENT 'AI推理过程',
    search_results TEXT COMMENT 'JSON格式的搜索结果',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_conversation_id (conversation_id),
    FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE
);
```

## 故障排除

### 常见问题

1. **连接被拒绝**
   ```
   com.mysql.cj.jdbc.exceptions.CommunicationsException: Communications link failure
   ```
   - 检查 MySQL 是否启动：`sudo systemctl status mysql`
   - 检查端口是否开放：`netstat -tlnp | grep 3306`

2. **字符编码问题**
   ```
   Incorrect string value: '\xE5\x9C\xA8\xE4\xBD\xA0...'
   ```
   - 确保数据库字符集为 utf8mb4
   - 检查连接URL中的字符编码参数

3. **权限问题**
   ```
   Access denied for user 'ai_chat_user'@'localhost'
   ```
   - 检查用户权限：`SHOW GRANTS FOR 'ai_chat_user'@'localhost';`
   - 重新授权或使用 root 用户

4. **时区问题**
   ```
   The server time zone value 'CST' is unrecognized
   ```
   - 在连接URL中添加：`serverTimezone=Asia/Shanghai`

### 性能优化

1. **索引优化**
   - user_id 字段已添加索引
   - conversation_id 字段已添加索引
   - 根据查询模式添加复合索引

2. **连接池配置**
   ```yaml
   spring:
     datasource:
       hikari:
         maximum-pool-size: 20
         minimum-idle: 5
         idle-timeout: 600000
         pool-name: HikariCP
         max-lifetime: 1800000
         connection-timeout: 30000
   ```

3. **查询优化**
   - 使用分页查询避免大量数据加载
   - 对频繁查询的字段添加索引
   - 定期分析慢查询日志

## 备份和恢复

### 数据备份
```bash
# 备份整个数据库
mysqldump -u ai_chat_user -p ai_chat > ai_chat_backup.sql

# 备份特定表
mysqldump -u ai_chat_user -p ai_chat users conversations messages > ai_chat_data.sql
```

### 数据恢复
```bash
# 恢复数据库
mysql -u ai_chat_user -p ai_chat < ai_chat_backup.sql
```