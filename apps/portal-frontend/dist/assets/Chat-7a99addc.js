import{i as ue,_ as _e,o as d,d as _,r as x,j as S,k as X,l as Ue,m as $e,c as w,e as l,n as P,f as v,p as u,t as h,q as A,w as m,F as T,s as I,v as H,T as xe,x as Ve,E as L,y as de,z as G,A as W,B as Pe,h as N,C as Te,D as Ne,G as Ee}from"./index-9588af27.js";import{a as Re}from"./axios-edfcd65b.js";const Ie=ue("user",{state:()=>({currentUser:null,isLoggedIn:!1}),actions:{setUser(n){this.currentUser=n,this.isLoggedIn=!0,localStorage.setItem("user",JSON.stringify(n))},logout(){this.currentUser=null,this.isLoggedIn=!1,localStorage.removeItem("user")},loadUserFromStorage(){const n=localStorage.getItem("user");n&&(this.currentUser=JSON.parse(n),this.isLoggedIn=!0)}}}),De=ue("chat",{state:()=>({conversations:[],currentConversation:null,messages:[],isLoading:!1,isConnected:!1,references:[],availableModels:[],selectedProvider:"",selectedModel:""}),actions:{setConversations(n){this.conversations=n||[]},setCurrentConversation(n){this.currentConversation=n||null},setMessages(n){this.messages=n||[]},addMessage(n){this.messages.push(n)},setLoading(n){this.isLoading=!!n},setConnected(n){this.isConnected=!!n},setReferences(n){this.references=Array.isArray(n)?n:[]},setAvailableModels(n){this.availableModels=Array.isArray(n)?n:[]},setSelectedProvider(n){this.selectedProvider=n||""},setSelectedModel(n){this.selectedModel=n||""}}}),y=Re.create({baseURL:"/api",timeout:15e3,headers:{"Content-Type":"application/json;charset=UTF-8"}});y.interceptors.response.use(n=>n.data,n=>Promise.reject(n));const Y={getList:n=>y.get("/conversations",{params:{userId:n}}),create:n=>y.post("/conversations",n),getDetail:n=>y.get(`/conversations/${n}`),delete:n=>y.delete(`/conversations/${n}`),getMessages:n=>y.get(`/conversations/${n}/messages`)},Oe={getAvailableProviders:()=>y.get("/models/providers"),getProviderModels:n=>y.get(`/models/providers/${n}/models`),getAllAvailableModels:()=>y.get("/models/available"),getModelInfo:(n,g)=>y.get(`/models/providers/${n}/models/${g}`),checkModelAvailability:(n,g)=>y.get(`/models/providers/${n}/models/${g}/available`),getUserDefaultModel:n=>y.get(`/models/users/${n}/default`),getUserModelPreferences:n=>y.get(`/models/users/${n}/preferences`)};const Be={name:"MarkdownView",props:{content:{type:String,default:""},enableTypewriter:{type:Boolean,default:!1},anchorPrefix:{type:String,default:""}}},Je=["innerHTML"];function ze(n,g,t,U,V,D){return d(),_("div",{class:"markdown",innerHTML:t.content},null,8,Je)}const Fe=_e(Be,[["render",ze],["__scopeId","data-v-f629db6f"]]);const je={class:"chat-page"},Ke={class:"sidebar__top"},He={key:0,class:"sidebar__identity"},Ge={class:"sidebar__avatar"},We={class:"sidebar__identity-details"},qe={class:"sidebar__name"},Qe={key:0,class:"sidebar__meta"},Xe={key:0,class:"sidebar__list"},Ye=["title","onClick"],Ze={class:"conversation__badge"},es={class:"conversation__body"},ss={class:"conversation__title"},ts={class:"conversation__meta"},ns={key:1,class:"sidebar__empty"},as={class:"main"},ls={class:"main__title-block"},is={class:"main__title"},os={class:"main__meta"},rs={class:"main__controls"},cs={class:"model-option"},ds={class:"model-option__label"},us={key:0,class:"model-option__tag"},_s={key:1,class:"model-option__tag model-option__tag--thinking"},gs={key:0,class:"model-option__meta"},ps={key:0,class:"empty-state"},vs={class:"message__avatar"},hs={class:"message__bubble"},ms={class:"message__bubble-header"},ys={class:"message__role"},fs={class:"message__actions"},bs={class:"message__time"},ks={class:"message__content"},Ss={key:0,class:"typing-indicator"},ws={class:"main__composer"},Cs={class:"main__toolbar"},Ms={class:"main__options"},As={class:"main__actions"},Ls={class:"insight__header"},Us={class:"insight__header-left"},$s={key:0,class:"insight__collapsed-label"},xs={key:1,class:"insight__body"},Vs={key:0,class:"insight__empty"},Ps={key:1,class:"insight__empty"},Ts={key:2,class:"insight__list"},Ns=["onClick"],Es={class:"insight__item-header"},Rs={class:"insight__item-title"},Is={class:"insight__item-meta"},Ds={key:0,class:"insight__item-snippet"},Os={__name:"Chat",setup(n){const g=Ie(),t=De(),U=x(""),V=x(!0),D=x(!1),O=x(null),B=x(!1),$=x(!1),C=x(!1),ge=S(()=>({"chat-shell--left-collapsed":$.value,"chat-shell--right-collapsed":C.value})),Z=S(()=>{var e,a,r,f,c;const s=((e=g.currentUser)==null?void 0:e.nickname)||((a=g.currentUser)==null?void 0:a.username)||((r=g.currentUser)==null?void 0:r.email)||"你";return((c=(f=s==null?void 0:s.trim())==null?void 0:f.charAt(0))==null?void 0:c.toUpperCase())||"你"}),ee=S(()=>{var s,e;return((s=g.currentUser)==null?void 0:s.username)||((e=g.currentUser)==null?void 0:e.email)||""}),pe=S(()=>{var s,e;return((e=(s=t.currentConversation)==null?void 0:s.title)==null?void 0:e.trim())||"未命名对话"}),ve=S(()=>{var e;const s=((e=t.messages)==null?void 0:e.length)||0;return s?`${s} 条消息`:"暂无消息"}),se=S(()=>Array.isArray(t.references)?t.references:[]),J=S(()=>(Array.isArray(t.availableModels)?t.availableModels:[]).map((e,a)=>{const r=(e==null?void 0:e.name)||(e==null?void 0:e.displayName)||((e==null?void 0:e.id)!=null?String(e.id):`provider_${a}`),f=(e==null?void 0:e.displayName)||(e==null?void 0:e.name)||`提供者 ${a+1}`,b=(Array.isArray(e==null?void 0:e.models)?e.models:[]).map((o,j)=>{const R=(o==null?void 0:o.name)||(o!=null&&o.displayName?`${o.displayName}`:(o==null?void 0:o.id)!=null?String(o.id):`model_${a}_${j}`),K=JSON.stringify({provider:r,model:R}),i=(o==null?void 0:o.displayName)||(o==null?void 0:o.name)||`模型 ${j+1}`,p=[];return o!=null&&o.name&&(o!=null&&o.displayName)&&o.displayName!==o.name&&p.push(o.name),o!=null&&o.maxTokens&&p.push(`上限 ${o.maxTokens}`),{key:K,label:i,providerValue:r,providerLabel:f,modelValue:R,disabled:(o==null?void 0:o.available)===!1,supportsStreaming:(o==null?void 0:o.supportsStreaming)!==!1,supportsThinking:(o==null?void 0:o.supportsThinking)===!0,meta:p.join(" · ")}}),k=b.some(o=>!o.disabled);return{key:r||`provider_${a}`,label:f,providerValue:r,disabled:!k,options:b}})),z=S(()=>J.value.some(s=>s.options.some(e=>!e.disabled))),q=S({get:()=>t.selectedProvider&&t.selectedModel?JSON.stringify({provider:t.selectedProvider,model:t.selectedModel}):"",set:s=>{if(!s){t.setSelectedProvider(""),t.setSelectedModel("");return}try{const e=JSON.parse(s);t.setSelectedProvider((e==null?void 0:e.provider)||""),t.setSelectedModel((e==null?void 0:e.model)||"")}catch(e){console.warn(e),t.setSelectedProvider(""),t.setSelectedModel("")}}}),te=()=>{const s=J.value;if(!s.length||!z.value){(t.selectedProvider||t.selectedModel)&&(t.setSelectedProvider(""),t.setSelectedModel(""));return}if(!s.some(a=>a.options.some(r=>!r.disabled&&r.providerValue===t.selectedProvider&&r.modelValue===t.selectedModel))){for(const a of s)if(!a.disabled){for(const r of a.options)if(!r.disabled){t.setSelectedProvider(r.providerValue),t.setSelectedModel(r.modelValue);return}}t.setSelectedProvider(""),t.setSelectedModel("")}};X(J,()=>{te()});const F=async()=>{await de();try{O.value&&(O.value.scrollTop=O.value.scrollHeight)}catch(s){console.warn(s)}};X(()=>t.messages.length,()=>{F()}),X(V,s=>{s||t.setReferences([])});const ne=s=>{const a=[...s||[]].reverse().find(r=>(r==null?void 0:r.role)==="assistant"&&Array.isArray(r==null?void 0:r.references)&&r.references.length);a?t.setReferences(a.references):t.isLoading||t.setReferences([])};let M=null;const E=()=>{try{M&&M.close()}catch(s){console.warn(s)}M=null},ae=async()=>{var s;if((s=g.currentUser)!=null&&s.id)try{const e=await Y.getList(g.currentUser.id);e!=null&&e.success&&t.setConversations(e.data)}catch(e){console.warn(e)}},he=async s=>{try{const e=await Y.getMessages(s),a=(e==null?void 0:e.data)||[];t.setMessages(a),ne(a)}catch{L.error("加载对话失败，请稍后重试"),t.setMessages([]),t.setReferences([])}await F()},le=async s=>{s!=null&&s.id&&(E(),t.setCurrentConversation(s),await he(s.id))},me=s=>{var a;const e=((a=s==null?void 0:s.title)==null?void 0:a.trim())||String((s==null?void 0:s.id)||"");return e?e.charAt(0).toUpperCase():"#"},ye=async()=>{var s;if(!(!((s=g.currentUser)!=null&&s.id)||B.value)){B.value=!0;try{const e=await Y.create({userId:g.currentUser.id,title:"新对话"});if(e!=null&&e.success){await ae();const a=(t.conversations||[])[0]||e.data;await le(a)}}catch{L.error("新建对话失败，请稍后再试")}finally{B.value=!1}}},fe=s=>{s.shiftKey||(s.preventDefault(),re())},be=s=>{if(!s)return"";const e=s.content;return typeof e=="string"?e:Array.isArray(e)?e.filter(a=>a!=null).map(a=>String(a)).join(`
`):e&&typeof e=="object"?JSON.stringify(e,null,2):String(e??"")},ke=async s=>{var a;const e=be(s);if(!e.trim()){L.warning("暂无可复制内容");return}try{if((a=navigator==null?void 0:navigator.clipboard)!=null&&a.writeText)await navigator.clipboard.writeText(e);else{const r=document.createElement("textarea");r.value=e,r.style.position="fixed",r.style.opacity="0",document.body.appendChild(r),r.select(),document.execCommand("copy"),document.body.removeChild(r)}L.success("已复制")}catch(r){console.warn(r),L.error("复制失败，请手动选择文本")}},Se=s=>{if(!s)return new Date().toLocaleString();try{return new Date(s).toLocaleString()}catch{return s}},we=s=>{const e=(s==null?void 0:s.updatedAt)||(s==null?void 0:s.createdAt);if(!e)return"刚刚创建";try{const a=new Date(e);return`${a.toLocaleDateString()} ${a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`}catch{return"时间未知"}},Ce=(s,e)=>(s==null?void 0:s.id)||(s==null?void 0:s.url)||(s==null?void 0:s.link)||e,Me=s=>{const e=(s==null?void 0:s.url)||(s==null?void 0:s.link);if(e)try{typeof window<"u"&&window.open(e,"_blank","noopener")}catch(a){console.warn(a)}},Ae=s=>{if(s!=null&&s.source)return s.source;if(s!=null&&s.domain)return s.domain;if(s!=null&&s.provider)return s.provider;const e=(s==null?void 0:s.url)||(s==null?void 0:s.link);if(!e)return"未知来源";try{return new URL(e).host}catch{return e}},ie=()=>{$.value=!$.value},oe=()=>{C.value=!C.value},Le=async()=>{try{const s=await Oe.getAllAvailableModels();s!=null&&s.success&&Array.isArray(s.data)?t.setAvailableModels(s.data):(t.setAvailableModels([]),t.setSelectedProvider(""),t.setSelectedModel(""))}catch(s){console.warn(s),t.setAvailableModels([]),t.setSelectedProvider(""),t.setSelectedModel("")}await de(),te()},re=async()=>{var a,r;if(t.isLoading){L.warning("请等待当前回复完成");return}if(!((a=t.currentConversation)!=null&&a.id)||!U.value.trim())return;if(!t.selectedProvider||!t.selectedModel){L.warning("请先选择模型");return}const s=U.value;U.value="",t.addMessage({id:Date.now(),role:"user",content:s,createdAt:new Date}),t.addMessage({id:Date.now()+1,role:"assistant",content:"",createdAt:new Date,references:[]}),await F(),t.setLoading(!0),t.setReferences([]),E();const e=new URLSearchParams({message:s,searchEnabled:String(V.value),deepThinking:String(D.value)});(r=g.currentUser)!=null&&r.id&&e.set("userId",String(g.currentUser.id)),e.set("provider",t.selectedProvider),e.set("model",t.selectedModel),M=new EventSource(`/api/chat/stream/${t.currentConversation.id}?${e.toString()}`),M.addEventListener("chunk",f=>{try{const c=JSON.parse(f.data),b=typeof c=="string"?c:(c==null?void 0:c.data)??(c==null?void 0:c.content)??"",k=t.messages[t.messages.length-1];k&&k.role==="assistant"&&(k.content=(k.content||"")+b,Array.isArray(c==null?void 0:c.references)?(k.references=c.references,t.setReferences(c.references)):Array.isArray(c==null?void 0:c.citations)&&(k.references=c.citations,t.setReferences(c.citations)),t.messages=[...t.messages]),F()}catch(c){console.warn(c)}}),M.addEventListener("search_results",f=>{try{const c=JSON.parse(f.data);if(Array.isArray(c)){t.setReferences(c);const b=t.messages[t.messages.length-1];b&&b.role==="assistant"&&(b.references=c,t.messages=[...t.messages])}}catch(c){console.warn(c)}}),M.addEventListener("end",()=>{t.setLoading(!1),E(),ne(t.messages)}),M.addEventListener("error",()=>{t.setLoading(!1),E(),L.error("SSE 连接出错，请重试")})};return Ue(async()=>{typeof window<"u"&&(window.innerWidth<1180&&(C.value=!0),window.innerWidth<900&&($.value=!0)),g.loadUserFromStorage(),await Le(),g.isLoggedIn&&await ae()}),$e(()=>{E()}),(s,e)=>{var K;const a=w("el-button"),r=w("el-icon"),f=w("el-option"),c=w("el-option-group"),b=w("el-select"),k=w("el-tag"),o=w("el-tooltip"),j=w("el-input"),R=w("el-checkbox");return d(),_("div",je,[l("div",{class:P(["chat-shell",ge.value])},[l("aside",{class:P(["sidebar",{"sidebar--collapsed":$.value}])},[l("div",Ke,[v(a,{class:"sidebar__collapse",text:"",circle:"",icon:$.value?u(G):u(W),onClick:ie},null,8,["icon"]),u(g).currentUser?(d(),_("div",He,[l("div",Ge,h(Z.value),1),l("div",We,[l("span",qe,h(u(g).currentUser.nickname||"未命名用户"),1),ee.value?(d(),_("span",Qe,h(ee.value),1)):A("",!0)])])):A("",!0)]),v(a,{class:"sidebar__new",type:"primary",size:"small",loading:B.value,onClick:ye},{default:m(()=>[v(r,null,{default:m(()=>[v(u(Pe))]),_:1}),e[4]||(e[4]=l("span",{class:"sidebar__new-text"},"新对话",-1))]),_:1},8,["loading"]),(K=u(t).conversations)!=null&&K.length?(d(),_("div",Xe,[(d(!0),_(T,null,I(u(t).conversations,i=>{var p,Q,ce;return d(),_("div",{key:i.id,class:P(["conversation",{"conversation--active":((p=u(t).currentConversation)==null?void 0:p.id)===i.id}]),title:((Q=i.title)==null?void 0:Q.trim())||"对话 "+i.id,onClick:Bs=>le(i)},[l("div",Ze,h(me(i)),1),l("div",es,[l("div",ss,h(((ce=i.title)==null?void 0:ce.trim())||"对话 "+i.id),1),l("div",ts,h(we(i)),1)])],10,Ye)}),128))])):(d(),_("div",ns,[...e[5]||(e[5]=[l("p",null,"暂无历史对话",-1),l("p",null,"点击「新对话」立即开始交流",-1)])]))],2),l("section",as,[l("header",{class:P(["main__header",{"main__header--inactive":!u(t).currentConversation}])},[l("div",ls,[v(a,{class:"main__collapse-btn",text:"",circle:"",icon:$.value?u(G):u(W),onClick:ie},null,8,["icon"]),l("div",null,[l("h1",is,h(pe.value),1),l("p",os,h(ve.value),1)])]),l("div",rs,[v(b,{modelValue:q.value,"onUpdate:modelValue":e[0]||(e[0]=i=>q.value=i),placeholder:z.value?"选择模型":"暂无可用模型",size:"small",class:"main__model-select",filterable:"",disabled:!z.value},{default:m(()=>[(d(!0),_(T,null,I(J.value,i=>(d(),H(c,{key:i.key,label:i.label,disabled:i.disabled},{default:m(()=>[(d(!0),_(T,null,I(i.options,p=>(d(),H(f,{key:p.key,label:p.label,value:p.key,disabled:p.disabled},{default:m(()=>[l("div",cs,[l("div",ds,[N(h(p.label)+" ",1),p.supportsStreaming?(d(),_("span",us,"流式")):A("",!0),p.supportsThinking?(d(),_("span",_s,"深思")):A("",!0)]),p.meta?(d(),_("span",gs,h(p.meta),1)):A("",!0)])]),_:2},1032,["label","value","disabled"]))),128))]),_:2},1032,["label","disabled"]))),128))]),_:1},8,["modelValue","placeholder","disabled"]),u(t).isLoading?(d(),H(k,{key:0,size:"small",type:"warning"},{default:m(()=>[...e[6]||(e[6]=[N("生成中...",-1)])]),_:1})):A("",!0),v(a,{class:"main__collapse-btn",text:"",circle:"",icon:C.value?u(G):u(W),onClick:oe},null,8,["icon"])])],2),u(t).currentConversation?(d(),_("div",{key:1,class:"messages",ref_key:"messageList",ref:O},[v(xe,{name:"msg-fade",tag:"div",class:"messages__inner"},{default:m(()=>[(d(!0),_(T,null,I(u(t).messages,i=>(d(),_("div",{key:i.id,class:P(["message",`message--${i.role}`])},[l("div",vs,h(i.role==="user"?Z.value:"AI"),1),l("div",hs,[l("div",ms,[l("span",ys,h(i.role==="user"?"你":"助手"),1),l("div",fs,[v(o,{content:"复制内容",placement:"top"},{default:m(()=>[v(a,{text:"",circle:"",size:"small",icon:u(Te),onClick:p=>ke(i)},null,8,["icon","onClick"])]),_:2},1024)])]),l("div",bs,h(Se(i.createdAt)),1),l("div",ks,[i.role==="user"?(d(),_(T,{key:0},[N(h(i.content),1)],64)):(d(),H(Fe,{key:1,content:String(i.content||"")},null,8,["content"]))])])],2))),128))]),_:1}),u(t).isLoading?(d(),_("div",Ss,[...e[8]||(e[8]=[l("span",null,null,-1),l("span",null,null,-1),l("span",null,null,-1)])])):A("",!0)],512)):(d(),_("div",ps,[...e[7]||(e[7]=[l("h2",null,"开始新的对话",-1),l("p",null,"在左侧选择一个已有对话，或点击新对话按钮，即可开启与 AI 的交流。",-1)])])),l("footer",ws,[v(j,{class:"main__input",modelValue:U.value,"onUpdate:modelValue":e[1]||(e[1]=i=>U.value=i),type:"textarea",rows:3,disabled:!u(t).currentConversation,placeholder:u(t).currentConversation?"输入你的问题，Enter 发送，Shift+Enter 换行":"请先在左侧选择或创建一个对话",onKeydown:Ve(fe,["enter"])},null,8,["modelValue","disabled","placeholder"]),l("div",Cs,[l("div",Ms,[v(R,{modelValue:V.value,"onUpdate:modelValue":e[2]||(e[2]=i=>V.value=i)},{default:m(()=>[...e[9]||(e[9]=[N("联网搜索",-1)])]),_:1},8,["modelValue"]),v(R,{modelValue:D.value,"onUpdate:modelValue":e[3]||(e[3]=i=>D.value=i)},{default:m(()=>[...e[10]||(e[10]=[N("深度思考",-1)])]),_:1},8,["modelValue"])]),l("div",As,[v(a,{type:"primary",size:"large",disabled:!u(t).currentConversation||!U.value.trim()||u(t).isLoading||!q.value||!z.value,loading:u(t).isLoading,onClick:re},{default:m(()=>[...e[11]||(e[11]=[N("发送",-1)])]),_:1},8,["disabled","loading"])])])])]),l("aside",{class:P(["insight",{"insight--collapsed":C.value}])},[l("div",Ls,[l("div",Us,[v(r,null,{default:m(()=>[v(u(Ne))]),_:1}),e[12]||(e[12]=l("span",{class:"insight__title"},"搜索引用",-1))]),v(a,{class:"insight__collapse",text:"",circle:"",icon:C.value?u(G):u(W),onClick:oe},null,8,["icon"])]),C.value?(d(),_("div",$s,"引用")):(d(),_("div",xs,[V.value?se.value.length?(d(),_("div",Ts,[(d(!0),_(T,null,I(se.value,(i,p)=>(d(),_("div",{key:Ce(i,p),class:"insight__item",onClick:Q=>Me(i)},[l("div",Es,[v(r,null,{default:m(()=>[v(u(Ee))]),_:1}),l("div",Rs,h(i.title||i.name||"未命名引用"),1)]),l("div",Is,h(Ae(i)),1),i.snippet||i.summary?(d(),_("div",Ds,h(i.snippet||i.summary),1)):A("",!0)],8,Ns))),128))])):(d(),_("div",Ps,[...e[14]||(e[14]=[l("p",null,"暂无引用数据",-1),l("p",null,"发送问题后将展示命中的参考资料",-1)])])):(d(),_("div",Vs,[...e[13]||(e[13]=[l("p",null,"未开启联网搜索",-1),l("p",null,"勾选左下方「联网搜索」后可查看引文",-1)])]))]))],2)],2)])}}},Fs=_e(Os,[["__scopeId","data-v-310cfc67"]]);export{Fs as default};
